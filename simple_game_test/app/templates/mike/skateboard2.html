<!DOCTYPE html>
<html>
  <head>
    <title>Simulation</title>

    <script src="/static/lib/jquery-min.js" type="text/javascript"> </script>
    <script>
        var $jq = jQuery.noConflict();
        console.log($jq); // Debug: Testing the conflict-free jQuery reference
    </script>

    <script src="/static/lib/underscore-min.js" type="text/javascript"> </script>
    <script src="/static/lib/backbone-min.js" type="text/javascript"> </script>
    <script src="/static/lib/d3.v3.min.js" type="text/javascript"> </script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="/static/css/bootstrap.min.css.4.3.1.css" type="text/css" /> -->
    <link rel="stylesheet" href="/static/css/style.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/jspsych.css" type="text/css" />
    
    
    <style type="text/css">
    .likert ul
        {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        .likert li
        {
            float: left;
            text-align: left;
            list-style-type: none;
            padding:10px;
        }

        .pre_info{
            float: center;
            text-align: center;
        }
            /* Add your CSS styles here */
        #center-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        }
        
        #loading-container {
        display: flex;
        align-items: center;
        color: #333;
        }
        
        #loading-text {
        margin-top: 10px;
        color: #333;
        font-size: 24px;
        }
        
        .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3498db;
        animation: spin 1s linear infinite;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 10px;
        }
        
        @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
        }

        /* Style for the message container */
        #message-container {
        border: 1px solid #ddd;
        padding: 20px;
        margin: 20px 0;
        background-color: #9ca9e4ea;
        min-height: 50px;
        text-align: center;
        font-size: large;
        color: #333;
        }

        #flashMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: orange;
            color: black;
            font-size: 20px;
            font-weight: bold;
            z-index: 1000;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: flashAnimation 0.5s alternate infinite;
        }

        #wait {
        font-size: 18px; /* Increase or decrease the font size as needed */
        color: #555; /* Set the font color */
        text-align: center; /* Center the text */
        padding: 10px; /* Add padding */
        background-color: #f3a581; /* Set a background color */
        border-radius: 5px; /* Optional: add rounded corners */
        }

        #preamble {
        display: flex;
        align-items: center; /* Vertically align items in the center */
        justify-content: space-between; /* Space out the header and timer */
        margin-bottom: 20px; /* Add some spacing below the preamble */
        }

        #header {
        text-align: center;
        margin-bottom: 20px;
        }

        /* Flexbox for the top section */
        #top-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px; /* Space between timer and progress tracker */
        }


        /* Timer styling */
        #timer-display {
            font-size: 18px;
            padding: 8px 12px;
            background-color: #d8eafd;
            border: 1px solid #4876c2;
            border-radius: 5px;
            color: #000;
            width: fit-content;
            text-align: left;
        }

        /* Teammates progress styling */
        #teammates-progress-tracker {
            background-color: #67c28a;
            padding: 10px 15px;
            border: 1px solid #275c42;
            border-radius: 5px;
            width: fit-content;
            text-align: left;
        }

        /* Info section styling */
        #info_main {
            margin-top: 20px;
            padding: 15px;
            background-color: #fcfdffea;
            border: 1px solid #275c42;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1.5;
            text-align: center;
            color: #333;
        }

        #teammates-progress p {
            font-size: 14px;
            color: #333;
            margin: 5px 0;
        }


        @keyframes flashAnimation {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        table {
            /* #font-size: 0.8em; /* Reduce font size */
            padding: 0; /* Remove padding */
            margin: 0; /* Remove margin */
            line-height: 1; /* Reduce line height */
        }

        @keyframes flash {
            0% { background-color: red; color: white; }
            50% { background-color: white; color: red; }
            100% { background-color: red; color: white; }
        }

        .flash-timer {
            animation: flash 1s linear infinite;
            border: 2px solid red;
            border-radius: 5px;
        }


    </style>
  </head>



  <body>
    <div class="container-fluid" style="padding-left: 5%; padding-right: 5%">
        <div id="container-instructions" class="text-center">
          <!-- non button section, id'd by non-buttons, should be entirely replaced by
          survey when we get to end of all of training -->
          <div id="non-buttons">
                <div id="center-container">
                    <div id="loading-container">
                        <div class="spinner"></div>
                        <div id="loading-text">Please wait until all members of your team have finished this stage and for the next session to be available. Loading the next instruction..</div>
                    </div>
                </div>
          
          <div id="header">
              <!-- <h1>Participant Gameplay</h1> -->
          </div>
          <hr class="my-4">
      
          <div id="preamble" class="pre_info" style="display: flex; flex-direction: column; gap: 20px;">
              <div id="top-section" style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div id="timer-display">
                      Timer: 0 seconds
                  </div>
                  <div id="teammates-progress-tracker">
                      <h4>Teammates' Progress</h4>
                      <div id="teammates-progress">
                      <!-- Progress details will be dynamically inserted here -->
                      </div>
                  </div>
              </div>
              <div id="info_main">
              </div>
          </div>
      
      
          <h2 id="debug"></h2><br><br><br>
          <div id="game_container" class="row justify-content-around">
              <canvas id="game" width="850" height="500"></canvas>
                  <div id="table_controlinfo"></div>
          </div>
      
          <div id="message-container"></div>
          <div id="score"></div>
          <!-- <div id="interaction_survey"></div> -->
          <div id="wait">Please wait until all members of your team have finished this round and for the next session to be available.</div>
          <div id="flashMessage"></div>
          <div id="feedback"></div>
          <div id="survey"></div>
          <hr>
          <br>
          </div>
      
          <div id="instructions" class="instructionsnav">
              <div class="row justify-content-between">
                <div class="col-xs-3">
                  <button type="button" id="prev" onclick="prev()" value="previous" class="btn btn-primary btn-lg continue"> Previous <span class="glyphicon glyphicon-arrow-left"></span>
                  </button>
                </div>
                <div class="col-xs-3">
                  <button type="button" id="next" disabled
                  onclick="next()"
                  value="next" class="btn btn-primary btn-lg continue">
                  Next <span class="glyphicon glyphicon-arrow-right"></span>
                  </button>
                </div>
              </div>
          </div>
          <br>
          <br>
          </div>
    </div>

    <script>

            
        let audio; // Declare the audio variable globally
        let inactivityTimeout; // To store the inactivity timeout
        inactivityLimit_min = 2
        inactivityLimit_s = inactivityLimit_min * 60
        const inactivityLimit = inactivityLimit_s * 1000; // 2 minutes in milliseconds
        let timerDisplayInterval; // Store the interval for updating the timer display
        let timerSeconds = 0; // Track elapsed time in seconds
        let isKickedOut = false; // Track if the user has been kicked out due to inactivity

        // hide the game instructions and preamble and show a loading screen while waiting to receive the necessary game data
        document.getElementById('instructions').style.display = 'none';
        document.getElementById('preamble').style.display = 'none';
        document.getElementById('wait').style.display = 'none';
        document.getElementById('message-container').style.display = 'none';
        document.getElementById('flashMessage').style.display = 'none';

        var socket = io();
        const loadingText = document.getElementById('loading-text');


        // Function to reset the inactivity timer
        function resetInactivityTimer() {
            // Clear any existing timer
            clearTimeout(inactivityTimeout);
            clearInterval(timerDisplayInterval);
            timerSeconds = inactivityLimit_s; // Reset the elapsed time
            updateTimerDisplay(); // Update the display immediately
            
            console.log("Resetting inactivity timer...");
            
            // Set a new timer
            inactivityTimeout = setTimeout(() => {
                // Notify the server to disconnect the user
                console.log("User inactive for ${inactivityLimit_min} minutes. Disconnecting...");
                final_data = populateData()
                isKickedOut = true;
                // Show the alert first
                alert("You have been disconnected due to inactivity. You are being removed from the study.");

                // Stop the audio and hide the flash message (if active)
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
                document.getElementById("flashMessage").style.display = "none";
                
                socket.emit("disconnect_user", final_data);
            }, inactivityLimit);

            // Start the timer display interval
            timerDisplayInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                // Apply flashing effect for the last 10 seconds
                const timerDisplay = document.getElementById("timer-display");
                if (timerSeconds <= 20) {
                    timerDisplay.classList.add("flash-timer");
                } else {
                    timerDisplay.classList.remove("flash-timer");
                }


                if (timerSeconds <= 0) {
                    clearInterval(timerDisplayInterval); // Stop the interval once it reaches zero
                }
            }, 1000);

        }

            
        // Function to update the timer display
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById("timer-display");
            if (timerDisplay) {
                timerDisplay.textContent = `Timer: ${timerSeconds} seconds`;
            }
        }


        function populateData() {
            let data = {};
            data["domain"] = localStorage.getItem("domain");
            data["interaction type"] = localStorage.getItem("interaction type");
            data["survey"] = localStorage.getItem("survey")
            data["iteration"] = Number(localStorage.getItem("iteration"));
            data["subiteration"] = Number(localStorage.getItem("subiteration"));

            data["user input"] = JSON.parse(localStorage.getItem("user input"));
            data["movement"] = localStorage.getItem("movement");
            data["attn1"] = localStorage.getItem("attn1");
            data["attn2"] = localStorage.getItem("attn2");
            data["attn3"] = localStorage.getItem("attn3");
            data["use1"] = localStorage.getItem("use1");
            data["use2"] = localStorage.getItem("use2");
            data["use3"] = localStorage.getItem("use3");
            data["understanding"] = localStorage.getItem("understanding");
            data["engagement_input"] = localStorage.getItem("engagement_input");
            data["improvement_input"] = localStorage.getItem("improvement_input");
            data["already completed"] = localStorage.getItem("already completed");
            data["room_name"] = localStorage.getItem("room_name");
            data["last_activity"] = localStorage.getItem("last_activity");
            data["last_activity_time"] = localStorage.getItem("last_activity_time");
            data["new_domain"] = localStorage.getItem("new_domain");

            reward_wt_1 = localStorage.getItem("reward_ft_wt_1_field")
            reward_wt_2 = localStorage.getItem("reward_ft_wt_2_field")
            console.log("Getting reward function weights: ", reward_wt_1, reward_wt_2)
            console.log('Getting engagement_input from local storage:', localStorage.getItem("engagement_input"));
            console.log('Getting improvement short answer from local storage:', localStorage.getItem("improvement_input"));

            if ((reward_wt_1 != null) && (reward_wt_2 != null)) {
                    data["reward_ft_weights"] = [reward_wt_1, reward_wt_2]
                } else {
                    data["reward_ft_weights"] = []
            }
            console.log("Set reward function weights: ", data["reward_ft_weights"])
            return data
        }


        socket.on("connect", function () {
            data = populateData()
            socket.emit("settings", data);
            localStorage.setItem("settings emit flag", "true");
            console.log("settings emit flag on connect", localStorage.getItem("settings emit flag"));
        });
        
        socket.on("member joined again", function (data) {
            console.log(data["user code"] + " has now joined");
        });



        socket.on("settings configured", function (data) {
            console.log('Received settings:', data);

            // reset
            localStorage.setItem("settings emit flag", "false");
            console.log("settings emit flag after settings configured", localStorage.getItem("settings emit flag"));
            
            //set
            localStorage.setItem("survey", "-1");
            localStorage.setItem("movement", "false");
            localStorage.setItem("user input", "{}");
            window.mdp_parameters = data["params"];
            window.interaction_type = data["interaction type"];
            localStorage.setItem("already completed", data["already completed"]);
            localStorage.setItem("interaction type", data["interaction type"]);

            // New
            localStorage.setItem("domain", data["domain"]);
            localStorage.setItem("iteration", data["iteration"]);
            localStorage.setItem("total iterations", data["total iterations"]);
            localStorage.setItem("lesson id", data["lesson id"]);
            localStorage.setItem("lesson string", data["lesson string"]);
            localStorage.setItem("optimal_traj", false);
            localStorage.setItem("new_domain", false);
            window.domain_completed = false;
            window.start_time_set = false;

            // window.last_test = false;

            if (data["last test"]) {
                    localStorage.setItem("last test", "true");
                    console.log("Reached last test in round");
            }
            else {
                localStorage.setItem("last test", "false");
            }

            if (!data["last iteration"]) {
                if (data["interaction type"] == "demo") {
                    window.joint_EOR = false;
                }
                window.last_in_round = false;
            }
            else {
                window.last_in_round = true;
                console.log("Reached last iteration in round");
            }

            if (data["domain completed"]) {
                console.log("domain completed");
                window.domain_completed = true;
            }

            
            
            // localStorage.setItem("game completed", "false");
            // localStorage.setItem("survey completed", "false");
            console.log('MDP params: ', data["params"], 'go_prev:', data["go prev"]);
            // types possible: demo, diagnostic test, diagnostic feedback, remedial demo, remedial test, remedial feedback, survey, final test
            
            if (data["go prev"] == false) {
                $jq("#prev").replaceWith(`<button type="button" id="prev" disabled onclick="prev()" value="previous" class="btn btn-primary btn-lg continue"> Previous <span class="glyphicon glyphicon-arrow-left"></span>
            </button>`);
            }
            else {
                $jq("#prev").replaceWith(`<button type="button" id="prev" onclick="prev()" value="previous" class="btn btn-primary btn-lg continue"> Previous <span class="glyphicon glyphicon-arrow-left"></span>
            </button>`);
            }

            if ((data["already completed"] == true)) {
                $jq("#next").replaceWith(`<button type="button" id="next"
                    onclick="next()"
                    value="next" class="btn btn-primary btn-lg continue">
                    Next <span class="glyphicon glyphicon-arrow-right"></span>
                    </button>` );
            }
            else {
                $jq("#next").replaceWith(`<button type="button" id="next" disabled
            onclick="next()"
            value="next" class="btn btn-primary btn-lg continue">
            Next <span class="glyphicon glyphicon-arrow-right"></span>
            </button>` );
            $jq("#survey").html(``);
            }
        
            // $jq("#debug").html(data["debug string"]);

            // hide the loading screen and show the game content
            document.getElementById('wait').style.display = 'none';
            document.getElementById('center-container').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('preamble').style.display = 'block';
            
            if (!window.interaction_type.includes('test')) {
            document.getElementById('message-container').style.display = 'none';
            }

            // don't show the previous button for final tests
            if (window.interaction_type == 'final test') {
                document.getElementById('prev').style.display = 'none';
            }
            

            console.log('Interaction type:', window.interaction_type);
            console.log('Params:', window.mdp_parameters);
            change_text(window.interaction_type);
            run_page(window.mdp_parameters);
            updateTeammatesProgress(data);
        });
    

        socket.on("all reached EOR", function (){
            console.log("received all reached EOR message...");

            let start_time = Date.now();
            while (Date.now() - start_time <= 1500) {
                console.log("All reached EOR...." + Date.now.toLocaleString());
            }

            // show the flash message
            var flashMessage = document.getElementById("flashMessage");
            flashMessage.style.display = 'block';
            flashMessage.innerHTML = "Next learning session is available now! Press any key to continue with the study.";

            // play the audio
            audio = new Audio("/static/audio/mixkit-positive-notification-951.wav");
            audio.loop = true;
            audio.play();

            // // Add event listener for keypress to hide the message and stop the audio
            // document.addEventListener('keydown', function() {
            //     // Hide the flash message
            //     flashMessage.style.display = 'none';
                
            //     // Stop the audio
            //     audio.pause();
            //     audio.currentTime = 0;  // Reset audio to start position

            //     document.removeEventListener('keydown', arguments.callee);
            // });

            document.addEventListener('keydown', handleKeydown);

            document.getElementById('wait').style.display = 'none';
            // next();  // automatically go to next session
            
            window.joint_EOR = true;

        });

        socket.on("force_logout", (data) => {
            console.log("Server forcefully logged out the user. Reason:", data.reason);
            alert(data.reason); // Show the reason for logout
            window.location.href = "{{ url_for('logout_confirmation') }}"; // Redirect to the logout confirmation page
        });
        
        
        
        function updateTeammatesProgress(data) {
            const teammatesContainer = document.getElementById("teammates-progress");
            teammatesContainer.innerHTML = ""; // Clear existing content

            // Iterate through the data for teammates
            for (const teammateId of [1, 2]){
                if (data[`teammate_${teammateId}_progress`] !== undefined){
                    // Create a new progress entry
                    const progressEntry = document.createElement("p");
                    progressEntry.textContent = `Teammate ${teammateId}: ${data[`teammate_${teammateId}_progress`]}`;
                    teammatesContainer.appendChild(progressEntry);
                }
            }
        }


        function handleKeydown(event) {
            // Hide the flash message
            flashMessage.style.display = 'none';

            // Stop the audio
            if (audio) {
                audio.pause();
                audio.currentTime = 0; // Reset audio to start position
            }

            // Remove this listener
            document.removeEventListener('keydown', handleKeydown);
        }

        // Shuffle function
        function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;
            while (0 !== currentIndex) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }
            return array;
        }


        // Assign html for interaction type
        function change_text(interaction_type){
            console.log("changing text for interaction type", interaction_type);

            // Define background colors for each interaction type
            const colors = {
                "final test": "lightcoral",
                "diagnostic test": "lightyellow",
                "demo": "lightgreen",
                "diagnostic feedback": "628dbe",  // same color as the agent in the game
                "default": "white" // Fallback color
            };

            const headerElement = document.getElementById("header");

            
            // change headers
            if (interaction_type == "final test") {
                console.log("final test");
                $jq("#header").html('<h1>Strategy assessment (' + (Number(localStorage.getItem("iteration"))).toString() + '/6)</h1>');
                // cl, pl, open, wtcl
                $jq("#info_main").html('<h3>Chip has finished teaching the game play strategy -- let\'s see how much you learned!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3><h4>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br>(We\'ll reveal which and how many of the six tests you answered correctly after the final one.)</h4>');
                // wt
                //$jq("#info_main").replaceWith('<h3>Chip has finished teaching the strategy -- let\'s see how much you learned!<br>Please demonstrate how you would complete this <b>game\'s task (dropping the pink circle at the grey square) </b> <br> ' +
                //'while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br>(We\'ll reveal which and how many of the six tests you answered correctly after the final one.)');
                document.getElementById('prev').style.display = 'none';
                headerElement.style.backgroundColor = colors["final test"];
            } 
            else if (interaction_type == "diagnostic test") {
                console.log("diagnostic test");
                $jq("#header").html('<h1><b> Lesson: ' + (Number(localStorage.getItem("lesson id"))).toString() + '/3.' + ' Check-in test (' + (Number(localStorage.getItem("iteration"))).toString() + '/' + localStorage.getItem("total iterations") + ')</b></h1>');
                if (localStorage.getItem("already completed") == 'true') {
                    $jq("#info_main").html('<h3>Let\'s see if you understood the previous demonstration(s)!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br><br><p><b>(Edit: You navigated back to this interaction so you may step through the answer using your space bar.)</b></p>');
                }
                else {
                    $jq("#info_main").html('<h3>Let\'s see if you understood the previous demonstration(s)!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.');
                }
                headerElement.style.backgroundColor = colors["diagnostic test"];

            }
            else if (interaction_type == "demo"){
                console.log("demo");
                if (localStorage.getItem("iteration")==1){
                    $jq("#header").html('<h1><i>' + localStorage.getItem("lesson string") + '<i/> <b> Lesson: ' + (Number(localStorage.getItem("lesson id"))).toString() + '/3.' + ' Demonstration of best strategy (' + (Number(localStorage.getItem("iteration"))).toString() + '/' + localStorage.getItem("total iterations") + ')</b></h1>');
                }
                else{
                    $jq("#header").html('<h1></b> Lesson: ' + (Number(localStorage.getItem("lesson id"))).toString() + '/3.' + ' Demonstration of best strategy (' + (Number(localStorage.getItem("iteration"))).toString() + '/' + localStorage.getItem("total iterations") + ')</b></h1>');
                }
                $jq("#info_main").html('<h3>Step through the demonstration <u>using your space bar</u>.<br>Feel free to run through it as many times as you wish by resetting, and at least once to continue!</h3>');
                headerElement.style.backgroundColor = colors["demo"];

            }
            else if (interaction_type == "diagnostic feedback"){
                console.log("diagnostic feedback");
                $jq("#header").html('<h1><b>Feedback</b></h1>');
                $jq("#info_main").html("<h3>Chip's optimal path to previous check-in test</h3>");
                headerElement.style.backgroundColor = colors["diagnostic feedback"];

            }
            else{
                console.log("default");
                $jq("#header").html('<h1></b>Participant gameplay</b></h1>');
                $jq("#info_main").html('<h3></h3>');
                headerElement.style.backgroundColor = colors["default"];

            }

            
            // change table and survey
            if (interaction_type === "survey") {
                var questions = [
                    {
                        question: "I was fully engaged with learning the game strategy.",
                        name: "attn1"
                    },
                    {
                        question: "The time I spent learning the game strategy passed by quickly.",
                        name: "attn2"
                    },
                    {
                        question: "I was absorbed in this experience.",
                        name: "attn3"
                    },
                    {
                        question: "I felt frustrated while learning the game strategy.",
                        name: "use1"
                    },
                    {
                        question: "I found learning the game strategy confusing.",
                        name: "use2"
                    },
                    {
                        question: "Learning the game strategy was taxing.",
                        name: "use3"
                    },
                ];
                // Shuffle the questions
                questions = shuffle(questions);

                // Generate the HTML
                var html = `<br></br>
                    <h2>The following statements ask you to <u>reflect on your experience of engaging with Chip</u> to learn the game strategy. For each statement, please use the following scale to indicate what is most true for you.</h2>
                    <br></br>`;

                for (var i = 0; i < questions.length; i++) {
                    html += `<h3>${questions[i].question}</h3>
                <div class="likert">
                <label><input name="${questions[i].name}" type="radio" value="1"/><span>Strongly Disagree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="2"/><span>Disagree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="3"/><span>Neither Agree nor Disagree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="4"/><span>Agree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="5"/><span>Strongly Agree</span></label>
                </div>
                <br></br>`;
                }

                html += `<h3>Finally, do you feel that you now understand the game strategy?</h3>
            <div class="likert">
                <label><input name="understanding" type="radio" value="1"/><span>Strongly Disagree</span></label>
                <label><input name="understanding" type="radio" value="2"/><span>Disagree</span></label>
                <label><input name="understanding" type="radio" value="3"/><span>Neither Agree nor Disagree</span></label>
                <label><input name="understanding" type="radio" value="4"/><span>Agree</span></label>
                <label><input name="understanding" type="radio" value="5"/><span>Strongly Agree</span></label>
                </div>
                <br></br>`;

                html += `<h3>Please feel free to explain any of your selections above or any comments or thoughts you'd like to share!</h3>
            <textarea id="engagement short answer" rows="4" cols="50"></textarea>`;

                // $jq("#non-buttons").html(html);

                $jq("#header").html('Survey questions for this game');
                $jq("#info_main").html(html);
                document.getElementById('team-progress-tracker').style.display = 'none';
            } 
            else if ((interaction_type == "diagnostic test") || (interaction_type == "final test")) {
                console.log("I am in the diagnostic/final test");
                if (localStorage.getItem("already completed") == 'true') {
                    $jq("#table_controlinfo").html(`<div><br><br>
                    <table width="500">
                        <tr><th>Key</th><th>Action</th></tr>
                        <tr><td>space bar</td><td>next movement</td></tr>
                        <tr><td>r</td><td>reset simulation</td></tr>
                    </table>
                    <br></div>`);
                }
                else{
                    $jq("#table_controlinfo").html(`<div><br><br><br><br>
                <table width="500">
                    <tr><th>Key</th><th>Action</th></tr>
                    <tr><td>up/down/left/right arrow keys</td><td>corresponding movement</td></tr>
                    <tr><td>p</td><td>pick up</td></tr>
                    <tr><td>d</td><td>drop</td></tr>
                    <tr><td>r</td><td>reset simulation</td></tr>
                </table>
                <br></div>`);
                }
            }
                
            else {
                $jq("#table_controlinfo").html(`<div><br><br><br>
            <table width="500">
                <tr><th>Key</th><th>Action</th></tr>
                <tr><td>space bar</td><td>next movement</td></tr>
                <tr><td>r</td><td>reset simulation</td></tr>
            </table>
            <br></div>`);
                $jq("#info_main").html('<h3> Look at the following demonstration on how you should complete this game while minimizing Chip`s energy loss.</h3><h3>Please answer the question below on the confidence of your <b>understanding</b> of the demonstration.</h3>');
            }
        }

        function prev() {
            console.log("I am going prev");
            localStorage.setItem("movement", "prev");
            window.location.href="{{ url_for('sb') }}";
        }


        function next() {
            idx = 0;
            localStorage.setItem("movement", "next");
            //localStorage.setItem("survey completed", "false");

            console.log("Domain completed?", window.domain_completed);
            
            data = populateData();


            if (!window.domain_completed){
                // if (window.last_test) {
                //     // document.getElementById('wait').innerHTML = "Please wait for the next session to be available.";
                //     document.getElementById('wait').style.display = 'block';
                // }

                // if (window.last_in_round) {
                //     // document.getElementById('wait').innerHTML = "Please wait for the next session to be available.";
                //     document.getElementById('wait').style.display = 'block';
                // }

                // hide the flash message
                document.getElementById('flashMessage').style.display = 'none';

                // if audio is playing, stop it
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }
            
            if (window.domain_completed) {
                // localStorage.setItem("last test", "false");
                                
                socket.emit("next domain", data);
                socket.on("next domain is", function(next_dom_data) {
                    console.log("I have received next domain");
                    localStorage.setItem("new_domain", true);
                    let url = "";
                    if (next_dom_data["domain"].length === 2){
                        // url = "/flask_closed_loop_teaching/".concat(data["domain"], "_intro");
                        if (next_dom_data["domain"] == 'at'){
                            url = "{{ url_for('at_intro') }}";
                        }
                        if (next_dom_data["domain"] == 'sb'){
                            url = "{{ url_for('sb_intro') }}";
                        }

                    }
                    else {
                        url = "{{ url_for('final_survey') }}";
                    }
                    window.location.href=url;
                });
                window.domain_completed = false;
            }

            else {
                window.location.href="{{ url_for('sb')}}";

            }
            
            // send data to server if not already sent after connect
            // if (localStorage.getItem("settings emit flag") == "false") {
            localStorage.setItem("settings emit flag", "true");
            console.log("settings emit flag next", localStorage.getItem("settings emit flag"));
            socket.emit("settings", data);
            // }
            // reset vars (in case trajectory was not completed)
            window.moves = [];
            window.agent_history = [];
            window.agent_history_nonoffset = [];

            // update the next button to be disabled
            if ((localStorage.getItem("last test") == "true" && localStorage.getItem("optimal_traj") == "true") || (window.last_in_round)){
                
                loadingText.innerHTML = `Please wait for all your teammates to complete. Loading the next instruction...)`

                // document.getElementById('wait').style.display = 'block';

                // $jq("#next").replaceWith(`<button type="button" id="next" disabled
                //     onclick="next()"
                //     value="next" class="btn btn-primary btn-lg continue">
                //     Next <span class="glyphicon glyphicon-arrow-right"></span>
                //     </button>`);
            }

        }
        
        addEventListener("beforeunload", (event) => {
            console.log("beforeunload event. isKickedOut: ", isKickedOut);
            if (!isKickedOut && localStorage.getItem("movement") === "false") {
                event.preventDefault();
                event.returnValue = "Are you sure you want to leave? The task is incomplete.";
            }

            // if (window.interaction_type === "survey") {
            //     let engagement_sa = document.getElementById("engagement short answer")
            //     if (engagement_sa) localStorage.setItem("engagement_input", engagement_sa.value);
            //     else localStorage.setItem("engagement_input", '');
            //     console.log("Setting engagement short answer....");
            //     console.log("engagement_input", engagement_sa);
            // }

            if (window.interaction_type !== "survey") {
                let engagement_sa = document.getElementById("engagement short answer")
                let improvement_sa = document.getElementById("improvement short answer")

                if (engagement_sa) localStorage.setItem("engagement_input", engagement_sa.value);
                else localStorage.setItem("engagement_input", '');
                if (improvement_sa) localStorage.setItem("improvement_input", improvement_sa.value);
                else localStorage.setItem("improvement_input", '');

                let simulation_rt = 0;
                if (localStorage.getItem("user input") === "{}") {
                    if (window.moves.length > 0) {
                        simulation_rt = performance.now() - window.start_time;
                    }
                    console.log('coordinates: ', window.agent_history_nonoffset);
                    final_data = JSON.stringify({
                        'moves': window.moves,
                        'opt_response': false,
                        'agent_history_nonoffset': window.agent_history_nonoffset,
                        'mdp_parameters': window.mdp_parameters,
                        'simulation_rt': simulation_rt,
                    });
                    localStorage.setItem("user input", final_data);
                }
            }

        });


        addEventListener("input", (event) => {
            console.log("input event", event.target);
            console.log("interaction type", window.interaction_type);
            console.log("last test", localStorage.getItem("last test"));

            if ((window.interaction_type == "final test") && (localStorage.getItem("last test") == "true")) {
                
                console.log('Setting guessed reward function weights...');
                reward_wt_1 = document.getElementById('reward_ft_wt_1').value;
                reward_wt_2 = document.getElementById('reward_ft_wt_2').value;

                localStorage.setItem('reward_ft_wt_1_field', reward_wt_1);
                localStorage.setItem('reward_ft_wt_2_field', reward_wt_2);
                
                if (reward_wt_1 !== "" && reward_wt_2 !== "") {
                    $jq("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>`);
                }
                else {
                    // disable button again if one of the fields is deleted
                    $jq("#next").replaceWith(`<button type="button" id="next" disabled
                            onclick="next()"
                            value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                    </button>`);
                }
            }
            else if (window.interaction_type !== "survey") {
                // checked based on input name
                let radioValue = $jq("input[name='info']:checked").val();
                if(radioValue) {
                    localStorage.setItem("survey", radioValue);
                    localStorage.setItem("survey completed", "true");

                    $jq("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>` );
                }
            }
            else {
                let attn1 = $jq("input[name='attn1']:checked").val();
                if(attn1) {
                    localStorage.setItem("attn1", attn1);
                }
                let attn2 = $jq("input[name='attn2']:checked").val();
                if(attn2) {
                    localStorage.setItem("attn2", attn2);
                }
                let attn3 = $jq("input[name='attn3']:checked").val();
                if(attn3) {
                    localStorage.setItem("attn3", attn3);
                }
                let use1 = $jq("input[name='use1']:checked").val();
                if(use1) {
                    localStorage.setItem("use1", use1);
                }
                let use2 = $jq("input[name='use2']:checked").val();
                if(use2) {
                    localStorage.setItem("use2", use2);
                }
                let use3 = $jq("input[name='use3']:checked").val();
                if(use3) {
                    localStorage.setItem("use3", use3);
                }
                let understanding = $jq("input[name='understanding']:checked").val();
                if(understanding) {
                    localStorage.setItem("understanding", understanding);
                }
                
                let engagement_sa = document.getElementById("engagement short answer")
                if (engagement_sa) localStorage.setItem("engagement_input", engagement_sa.value);
                else localStorage.setItem("engagement_input", '');
                console.log("Setting engagement short answer....");
                console.log("engagement_input", engagement_sa);

                if (attn1 && attn2 && attn3 && use1 && use2 && use3 && understanding) {
                    $jq("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>` );
                }
            }
        });

        function run_page(mdp_parameters) {
            console.log("running page....");
            
            // Start the inactivity timer when the page loads
            resetInactivityTimer();
            
            var canvas = document.getElementById("game");
            var context = canvas.getContext("2d");

            // variables for parent window
            var final_data = [];
            var data_sent = false;
            var show_likert = false;


            window.start_time = 0;
            window.moves = [];
            window.agent_history = [];
            window.agent_history_nonoffset = []; // this is for keep track of the agent's location in gridworld integers

            var offset_x = 1.25;
            var offset_y = 0.75;


            var text_color = "#394d7e";

            var map_layout = {};

            var spaceship =
            {
                color: "#628dbe",
                color_light: "#7cb8fc",
                width: 65,
                height: 130,
                grid_loc:
                {
                x: 0,
                    y: 0,
                    human_x: 0,
                    human_y: 0
                },
                taxi_set: false
            }
            var passenger =
            {
                color: "#C88B66",
                color_light: "#fcae7e",
                width: 350,
                height: 350,
                grid_loc:
                {
                    x: 0,
                    y: 0,
                    human_x: 0,
                    human_y: 0
                },
                picked: false,
                picked_human: false,
                dropped: false,
                // dropped_human: false
            }

            var goal = 
            {
                grid_loc:
                {
                    x: 0,
                    y: 0 
                }
            }

            function build_grid(){
                //create a grid
                temp = [];
                for (i = 0; i < mdp_parameters.height; i++) {
                    temp.push([0]);
                }
                for (j = 0; j < mdp_parameters.height-1; j++) {
                    for (k = 0; k < mdp_parameters.width-1; k++) {
                        temp[j].push(0)
                    }
                }
                return temp;
            }

            function set_grids()
            {
                //set location of taxi
                spaceship.grid_loc.x =  (mdp_parameters.agent.x-1) + offset_x;
                spaceship.grid_loc.y =  (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
                spaceship.grid_loc.human_x =  (mdp_parameters.agent.x-1) + offset_x + agent_human_spacer;
                spaceship.grid_loc.human_y =  (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
                window.agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y])
                window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                spaceship.taxi_set = true;

                if (mdp_parameters.skateboard.length > 0) {
                    //set location of passenger
                    if (mdp_parameters.agent.has_skateboard == 1){
                        passenger.picked = true;
                        passenger.picked_human = true;
                        passenger.grid_loc.x = (mdp_parameters.agent.x-1) + offset_x;
                        passenger.grid_loc.y = (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
                        passenger.grid_loc.human_x = (mdp_parameters.agent.x-1) + offset_x + agent_human_spacer;
                        passenger.grid_loc.human_y = (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
                    }
                    else{
                        passenger.grid_loc.x = (mdp_parameters.skateboard[0].x-1) + offset_x;
                        passenger.grid_loc.y = (mdp_parameters.height - mdp_parameters.skateboard[0].y) + offset_y;
                        passenger.grid_loc.human_x = (mdp_parameters.skateboard[0].x-1) + offset_x + agent_human_spacer;
                        passenger.grid_loc.human_y = (mdp_parameters.height - mdp_parameters.skateboard[0].y) + offset_y;
                    }
                }
                //set destination
                destination_grid = build_grid();
                destination_grid[mdp_parameters.height - mdp_parameters.goal.y][mdp_parameters.goal.x-1] = 1;
                map_layout.destination = destination_grid;

                //set walls
                color_locs = build_grid();
                for (i = 0; i < mdp_parameters.walls.length; i++) {
                    color_locs[mdp_parameters.height - mdp_parameters.walls[i].y][mdp_parameters.walls[i].x-1] = 1;
                }

                //set paths
                for (i = 0; i < mdp_parameters.paths.length; i++) {
                    color_locs[mdp_parameters.height - mdp_parameters.paths[i].y][mdp_parameters.paths[i].x-1] = 2;
                }
                map_layout.color_blocks = color_locs;

            }


            function drawTaxi(x,y,color)
            {
                if (spaceship.taxi_set == false){
                taxiSet();
                }
                context.save();
                context.beginPath();
                context.translate(100*(x) + 50 + translate_draw, 100*(y) + 150);
                    context.lineTo(-spaceship.width * 0.5 , -spaceship.height * 0.5);
                    context.lineTo(0, -spaceship.height);
                    context.lineTo(-spaceship.width * -0.5, -spaceship.height * 0.5);
                if (color == "light"){
                    context.fillStyle = spaceship.color_light;
                }
                else {
                    context.fillStyle = spaceship.color;
                }
                context.fill();
                context.closePath();
                context.restore();
            }

            function drawPassenger(x,y,color)
            {
                if (mdp_parameters.skateboard.length > 0) {
                    context.save();
                    context.beginPath();
                    var i = 0;
                    var j = 0;
                    if (color == "light"){
                        context.fillStyle = passenger.color_light;
                        condition = !passenger.picked_human;
                        if (!passenger.picked_human){
                            context.rect(x*100 + 25 + translate_draw, y*100 + 45, 50, 8);
                            context.fill();
                            context.closePath();
                        }
                        else{
                            context.rect(x*100 + 25 + translate_draw, y*100 + 77, 50, 8);
                            context.fill();
                            context.closePath();
                        }
                    context.restore();
                        }
                    else {
                        context.fillStyle = passenger.color;
                        condition = !passenger.picked;
                        if (!passenger.picked){
                            context.rect(x*100 + 25 + translate_draw, y*100 + 45, 50, 8);
                            context.fill();
                            context.closePath();
                        }
                        else{
                            context.rect(x*100 + 25 + translate_draw, y*100 + 77, 50, 8);
                            context.fill();
                            context.closePath();
                        }
                    context.restore();
                }
            }}

            function drawAgentHistory()
            {
                context.save();
                for (j = 0; j < window.agent_history.length; j++) {
                    context.beginPath();
                    if (j == 0) {
                        context.rect(window.agent_history[j][0]*100 + 37, window.agent_history[j][1]*100 + 48, 25, 4);
                        context.fillStyle = '#677387';
                    }
                    context.arc(window.agent_history[j][0]*100 + 50, window.agent_history[j][1]*100 + 50, 6, 0, 2 * Math.PI);
                    context.fillStyle = '#677387';
                    context.fill();
                    context.closePath();
                }
                context.restore();
            }

            function drawDestination()
            {
                context.save();
                context.beginPath();
                var i = 0;
                var j = 0;

                for (i = 0; i < mdp_parameters.height; i++) {
                    for (j = 0; j < mdp_parameters.width; j++) {
                        if (map_layout.destination[i][j] == 1){

                            context.beginPath();
                            context.rect(100*j + 15+offset_x*100+5, 100*i + 15 + offset_y*100+7, 60,55);
                            context.fillStyle = "rgb(162, 167, 152)";
                            context.fill();
                            context.closePath();
                        }
                    }
                }
                context.restore();
            }

            function drawMap()
            {
                context.save();
                var i;
                var j;
                for (i = 0; i < mdp_parameters.height; i++) {
                    for (j = 0; j < mdp_parameters.width; j++) {
                        if (map_layout.color_blocks[i][j] == 2){
                            context.beginPath();
                            context.rect(4 + 100*j+offset_x*100, 4+100*i + offset_y*100, 92, 92);
                            context.fillStyle = "#DCBBFC";
                            context.fill();
                            context.closePath();
                        }
                        if (map_layout.color_blocks[i][j] == 1){
                            context.beginPath();
                            context.rect(4 + 100*j+offset_x*100, 4+100*i + offset_y*100, 92, 92);
                            context.fillStyle = "#2E3131";
                            context.fill();
                            context.closePath();
                        }
                    }
                }
                context.restore();
            }


            function start_screen() {
                if (!map_layout.set){
                    set_grids();
                    map_layout.set = true;
                }
                // Clear entire screen
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.beginPath();
                context.fillStyle = "black";
                context.fill();
                context.closePath();

                //draw grid
                for (i = 0; i <= mdp_parameters.height; i++) {
                    context.beginPath();
                    context.moveTo(0+offset_x*100, 100*i-1+offset_y*100);
                    context.lineTo(0+offset_x*100, 100*i+1+offset_y*100);
                    context.lineTo(mdp_parameters.width*100+offset_x*100, 100*i+1+offset_y*100);
                    context.lineTo(mdp_parameters.width*100+offset_x*100, 100*i-1+offset_y*100);
                    context.fillStyle = "black";
                    context.fill();
                    context.closePath();
                }
                for (i = 0; i <= mdp_parameters.width; i++) {
                    context.beginPath();
                    context.moveTo(100*i-1+offset_x*100, 0+offset_y*100);
                    context.lineTo(100*i+1+offset_x*100, 0+offset_y*100);
                    context.lineTo(100*i+1+offset_x*100, mdp_parameters.height*100+offset_y*100);
                    context.lineTo(100*i-1+offset_x*100, mdp_parameters.height*100+offset_y*100);
                    context.fillStyle = "black";
                    context.fill();
                    context.closePath();
                }

                // indicate to the user that it's their turn to play
                if ((window.interaction_type.includes("test")) && (localStorage.getItem("already completed") == 'false')) {
                    context.font = "25px Arial";
                    context.fillStyle = text_color;
                    context.textAlign = "center";

                    context.fillText("Your turn to play!", offset_x * 100 + 305, 60);

                    // Draw blue border around the grid
                    context.beginPath();
                    context.rect(offset_x*100 - 3, offset_y*100 - 3, mdp_parameters.width*100 + 6, mdp_parameters.height*100 + 6);
                    context.strokeStyle = "blue";
                    context.lineWidth = 2;
                    context.stroke();
                }

                context.beginPath();
                // Begin drawing
                drawMap();
                drawDestination();
                if (mdp_parameters.tag  == -2){
                    drawTaxi(spaceship.grid_loc.human_x,spaceship.grid_loc.human_y,"light");
                    drawPassenger(passenger.grid_loc.human_x,passenger.grid_loc.human_y,"light");
                }
                if (mdp_parameters.tag  == -1){
                    drawAgentHistory();
                }
                drawTaxi(spaceship.grid_loc.x,spaceship.grid_loc.y,"normal");
                drawPassenger(passenger.grid_loc.x,passenger.grid_loc.y,"normal");
            }


            function record_data(){
                var end_time = performance.now();

                // record whether the user got the optimal trajectory or not
                same_traj = false;

                
                for (var j = 0; j < mdp_parameters.all_opt_actions.length; j++) {
                    same_traj_checked = false;
                    opt_moves = mdp_parameters.all_opt_actions[j]
                    if (window.moves.length == opt_moves.length) {
                        for (var k = 0; k < window.moves.length; k++) {
                            if (window.moves[k] != opt_moves[k]) {
                                // if one move differs, no need to consider other moves. they're not the same trajectory
                                same_traj_checked = true;
                                break;
                            }
                        }

                        // if you've found a matching trajectory, no need to check other trajectories
                        if (k ==window.moves.length) {
                            same_traj = true;
                            break;
                        }
                    }
                }

                // // sometimes the mdp_params does not contain all opt params, so do a simple check
                // if (!same_traj_checked && !same_traj) {
                //     if (window.moves.length == opt_moves.length){
                //         same_traj = true;
                //     }
                // }

                //console.log('skateboard2_' + mdp_parameters.test_difficulty + '_' + mdp_parameters.tag.toString());
                //console.log(same_traj);

                // // the two test demonstrations at each level of difficulty are always pairs of an even and odd number
                // if (mdp_parameters.tag % 2 == 0) {
                //     sessionStorage.setItem('skateboard2_' + mdp_parameters.test_difficulty + '_a', same_traj)
                // }
                // else {
                //     sessionStorage.setItem('skateboard2_' + mdp_parameters.test_difficulty + '_b', same_traj)
                // }

                var it = window.interaction_type
                if(it == "final test") {
                    sessionStorage.setItem('skateboard2_' + localStorage.getItem("iteration").toString(), same_traj)
                }


                final_data = JSON.stringify({
                    'simulation_rt': (end_time - window.start_time),
                    'moves': window.moves,
                    'opt_response': same_traj,
                    'agent_history_nonoffset': window.agent_history_nonoffset,
                    'mdp_parameters': mdp_parameters,
                });

                var event = new CustomEvent("game-completed", { "detail": "Demonstration has now ended." });
                // enableScroll();
                document.dispatchEvent(event);

                localStorage.setItem("user input", final_data);

                data_sent = true;

                // Display message based on whether the user got the optimal response
                var messageContainer = document.getElementById("message-container");
                messageContainer.innerHTML = ""; // Clear previous messages

                if (same_traj) {
                    message = "Congratulations! You followed an optimal path.";
                    messageContainer.style.backgroundColor = "#d4f1d4"; // Subtle green background
                    messageContainer.style.color = "#27632a"; // Darker green text color for readability
                } else {
                    message = "Unfortunately, you did not follow an optimal path. Let\'s review on the next page!";
                    messageContainer.style.backgroundColor = "#f8d6d8"; // Subtle red background
                    messageContainer.style.color = "#7b2b2d"; // Darker red text color for readability
                }

                // Display the message
                messageContainer.textContent = message;

                return same_traj
            }

            function draw() {
                console.log("I am in the draw function");
                if (!window.start_time_set) {
                    window.start_time = performance.now();
                    window.start_time_set = true
                }
                
                if (!map_layout.set) {
                    set_grids();
                    map_layout.set = true;
                }
                // Clear entire screen
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.beginPath();
                context.fillStyle = "black";
                context.fill();
                context.closePath();

                //draw grid
                for (i = 0; i <= mdp_parameters.height; i++) {
                    context.beginPath();
                    context.moveTo(0 + offset_x * 100, 100 * i - 1 + offset_y * 100);
                    context.lineTo(0 + offset_x * 100, 100 * i + 1 + offset_y * 100);
                    context.lineTo(mdp_parameters.width * 100 + offset_x * 100, 100 * i + 1 + offset_y * 100);
                    context.lineTo(mdp_parameters.width * 100 + offset_x * 100, 100 * i - 1 + offset_y * 100);
                    context.fillStyle = "black";
                    context.fill();
                    context.closePath();
                }
                for (i = 0; i <= mdp_parameters.width; i++) {
                    context.beginPath();
                    context.moveTo(100 * i - 1 + offset_x * 100, 0 + offset_y * 100);
                    context.lineTo(100 * i + 1 + offset_x * 100, 0 + offset_y * 100);
                    context.lineTo(100 * i + 1 + offset_x * 100, mdp_parameters.height * 100 + offset_y * 100);
                    context.lineTo(100 * i - 1 + offset_x * 100, mdp_parameters.height * 100 + offset_y * 100);
                    context.fillStyle = "black";
                    context.fill();
                    context.closePath();
                }

                // indicate to the user that it's their turn to play
                if ((window.interaction_type.includes("test")) && (localStorage.getItem("already completed") == 'false')) {
                    context.font = "25px Arial";
                    context.fillStyle = text_color;
                    context.textAlign = "center";

                    context.fillText("Your turn to play!", offset_x * 100 + 305, 60);

                    // Draw blue border around the grid
                    context.beginPath();
                    context.rect(offset_x*100 - 3, offset_y*100 - 3, mdp_parameters.width*100 + 6, mdp_parameters.height*100 + 6);
                    context.strokeStyle = "blue";
                    context.lineWidth = 2;
                    context.stroke();
                }


                context.beginPath();
                // Begin drawing
                drawMap();
                drawDestination();
                if (mdp_parameters.tag == -2) {
                    drawTaxi(spaceship.grid_loc.human_x, spaceship.grid_loc.human_y, "light");
                    drawPassenger(passenger.grid_loc.human_x, passenger.grid_loc.human_y, "light");
                }
                if (mdp_parameters.tag == -1) {
                    drawAgentHistory();
                }
                drawTaxi(spaceship.grid_loc.x, spaceship.grid_loc.y, "normal");
                drawPassenger(passenger.grid_loc.x, passenger.grid_loc.y, "normal");

                game_completed = false
                if (mdp_parameters.tag == -2) {
                    if (onGoal('agent') && onGoal('human')) game_completed = true;
                } else if (onGoal('agent')) game_completed = true;

                if (game_completed) {
                    canvas.removeEventListener('click', draw);
                    document.removeEventListener('keydown', keyPressed);
                    context.font = "bold 28px Arial";
                    context.fillStyle = text_color;
                    context.textAlign = "center";
                    context.fillText("Game completed!", (mdp_parameters.width * 100) / 2 + offset_x * 100, (mdp_parameters.height * 100) / 2 + offset_y * 100 + 250);
                    
                    
                    // if (window.interaction_type.includes('test') && localStorage.getItem("already completed") == 'false') {
                    //     document.getElementById('message-container').style.display = 'block';
                    // }
                    
                    // // watched_vid_arr[current_page] = true;
                    if (data_sent == false) {
                        var it = window.interaction_type;
                        var last_test = localStorage.getItem("last test");

                        same_traj = record_data()
                        localStorage.setItem("optimal_traj", same_traj)
                        console.log("same_traj: ", same_traj)
                        if (it == "diagnostic test") {
                            if (localStorage.getItem("already completed") === "false"){
                                document.getElementById('message-container').style.display = 'block';
                            }
                            if (same_traj && localStorage.getItem("already completed") === "false") {
                                // if the test was answered correctly or page wasn't already shown previously, show likert scale
                                show_likert = true
                                // if (localStorage.getItem("already completed") == 'false') $jq("#feedback").html('<div class="text-center"><h4>Great, you answered correctly!</h4><br></div>')
                            }
                            else {
                                // if the test was answered incorrectly or page was already shown previously, simply enable the next button
                                // set the likert value to 0 (changing from -1) so that you know that you've been to this page before
                                localStorage.setItem("survey", 0)

                                const subiteration = localStorage.getItem("subiteration")
                                // if (localStorage.getItem("already completed") == 'false') {
                                //     $jq("#feedback").html('<div class="text-center"><h4>Oh no, you answered incorrectly! Let\'s review on the next page!</h4><br></div>')
                                // }

                                $jq("#next").replaceWith(`<button type="button" id="next"
                                onclick="next()"
                                value="next" class="btn btn-primary btn-lg continue">
                                Next <span class="glyphicon glyphicon-arrow-right"></span>
                                </button>` );
                            }
                        } 
                        else if (it == "final test"){
                            if(last_test == "true"){
                                var score = 0;
                                var first = 0;
                                var second = 0;
                                var third = 0;
                                var fourth = 0;
                                var fifth = 0;
                                var sixth = 0;
                                if (sessionStorage.getItem('skateboard2_1') == 'true') {
                                    score += 1;
                                    first += 1;
                                }
                                if (sessionStorage.getItem('skateboard2_2') == 'true') {
                                    score += 1;
                                    second += 1;
                                }
                                if (sessionStorage.getItem('skateboard2_3') == 'true') {
                                    score += 1;
                                    third += 1;
                                }
                                if (sessionStorage.getItem('skateboard2_4') == 'true') {
                                    score += 1;
                                    fourth += 1;
                                }
                                if (sessionStorage.getItem('skateboard2_5') == 'true') {
                                    score += 1;
                                    fifth += 1;
                                }
                                if (sessionStorage.getItem('skateboard2_6') == 'true') {
                                    score += 1;
                                    sixth += 1;
                                }
                                console.log("game score: ", score)
                                $jq("#feedback").html('<div class="text-center"><h1>Score Results</h1><p>In order of the tests you took, you scored <p id="score_val"></p>getting <p id="score_val2" style="display:inline"></p> tests correctly out of 6.</p></div>')
                                document.getElementById('score_val').innerHTML = first + ' + ' + second + ' + ' + third  + ' + ' + fourth  + ' + ' + fifth + ' + ' + sixth + ' = ' + score
                                document.getElementById('score_val2').innerHTML = score

                                // exploratory data collection on whether people are able to explicitly predict the weights
                                // for cl, pl, open,
                                $jq("#survey").html("<br><h3>Finally, please provide your best guess of energy change of the actions below (the last one is given and decimals are allowed!):</h3><table class='center'><tr><th>Action</th><th>Sample sequence(s)</th><th>Energy change</th></tr><tr><td>Moving with the orange rectangle grabbed</td><td><img src = 'static/img/skateboard2_skateboard2.png' width='75' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/skateboard2_skateboard3.png' width='75' height=auto /></td><td><input id='reward_ft_wt_1' type='number' style='width: 4em;'</>%</td></tr><tr><td>Moving <u>out of</u> a purple square (e.g. into purple <u>or</u> white square)</td><td><img src = 'static/img/skateboard2_purple1.png' width='150' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/skateboard2_purple2.png' width='150' height=auto /></td><td><input id='reward_ft_wt_2' type='number' style='width: 4em;'</>%</td></tr><tr><td>Any action that you take (e.g. moving right, grabbing, etc) </td><td><img src = 'static/img/right1.png' width='150' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/right2.png' width='150' height=auto /><br><br><img src = 'static/img/skateboard2_skateboard1.png' width='75' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/skateboard2_skateboard2.png' width='75' height=auto /></td>  <td>-1.0%</td></tr></table>");
                            }
                            else{
                                // Next button is always enabled.
                                    $jq("#next").replaceWith(`<button type="button" id="next"
                                onclick="next()"
                                value="next" class="btn btn-primary btn-lg continue">
                                Next <span class="glyphicon glyphicon-arrow-right"></span>
                                </button>` );
                            }
                        } 
                        else if (localStorage.getItem("already completed") === "false") {
                            show_likert = true
                        }

                        if (show_likert){
                            $jq("#survey").html(`<h3>Did this interaction improve your understanding of the game strategy?</h3>
                        <div class="likert">
                        <label><input name="info" type="radio" value="1"/><span>Not at all</span></label>
                        <label><input name="info" type="radio" value="2"/><span>Slightly</span></label>
                        <label><input name="info" type="radio" value="3"/><span>Moderately</span></label>
                        <label><input name="info" type="radio" value="4"/><span>Very</span></label>
                        <label><input name="info" type="radio" value="5"/><span>Extremely</span></label>
                        </div>
                        <br></br>

        <h5>Please feel free to explain your selection if you wish!</h5>
                    <textarea id="improvement short answer" rows="2" cols="50"></textarea>
        ` );
            var textarea = document.querySelector('textarea');
            textarea.addEventListener('keydown', function(event) {
                event.stopPropagation();
            });
                        }
                    }
                }
            }


            function onGoal(version){
                if (version=="agent"){
                    if (map_layout.destination[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x-offset_x] == 1) {
                        console.log("agent here");
                        return true
                    }
                    else {
                        return false
                    }
                }
                else{
                    if (map_layout.destination[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x-offset_x-agent_human_spacer] == 1) {
                        console.log("human here");
                        return true
                    }
                    else {
                        return false
                    }
                }
            }

            function left(version) {
                if (version == "agent"){
                    if (spaceship.grid_loc.x > offset_x && map_layout.color_blocks[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x-1-offset_x] != 1){
                        if (passenger.picked) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x-1-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.x -= 1;
                        window.moves.push("left");
                        window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                        if (passenger.picked){
                            passenger.grid_loc.x -= 1;
                        }
                    }
                }
                else{
                    if (spaceship.grid_loc.human_x > offset_x && map_layout.color_blocks[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x-1-offset_x] != 1){
                        if (passenger.picked_human) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x-1-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.human_x -= 1;
                        if (passenger.picked_human){
                            passenger.grid_loc.human_x -= 1;
                        }
                    }
                }
            }

            function right(version) {
                if (version == "agent"){
                    if (spaceship.grid_loc.x < mdp_parameters.width-1+offset_x && map_layout.color_blocks[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x+1-offset_x] != 1){
                        if (passenger.picked) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x+1-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.x += 1;
                        window.moves.push("right");
                        window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                        if (passenger.picked){
                            passenger.grid_loc.x += 1;
                        }
                    }
                }
                else{
                    if (spaceship.grid_loc.human_x < mdp_parameters.width-1+offset_x && map_layout.color_blocks[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x+1-offset_x] != 1){
                        if (passenger.picked_human) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x+1-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.human_x += 1;
                        if (passenger.picked_human){
                            passenger.grid_loc.human_x += 1;
                        }
                    }
                }
            }

            function up(version) {
                if (version == "agent"){
                    if (spaceship.grid_loc.y > offset_y && map_layout.color_blocks[spaceship.grid_loc.y-1-offset_y][spaceship.grid_loc.x-offset_x] != 1){
                        if (passenger.picked) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.y-1-offset_y][spaceship.grid_loc.x-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.y -= 1;
                        window.moves.push("up");
                        window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                        if (passenger.picked){
                            passenger.grid_loc.y -= 1;
                        }
                    }
                }
                else{
                    if (spaceship.grid_loc.human_y > offset_y && map_layout.color_blocks[spaceship.grid_loc.human_y-1-offset_y][spaceship.grid_loc.human_x-offset_x] != 1){
                        if (passenger.picked_human) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.human_y-1-offset_y][spaceship.grid_loc.human_x-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.human_y -= 1;
                        if (passenger.picked_human){
                            passenger.grid_loc.human_y -= 1;
                        }
                    }
                }
            }

            function down(version) {
                if (version == "agent"){
                    if (spaceship.grid_loc.y < mdp_parameters.height-1+offset_y && map_layout.color_blocks[spaceship.grid_loc.y+1-offset_y][spaceship.grid_loc.x-offset_x] != 1){
                        if (passenger.picked) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.y+1-offset_y][spaceship.grid_loc.x-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.y += 1;
                        window.moves.push("down");
                        window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                        if (passenger.picked){
                            passenger.grid_loc.y += 1;
                        }
                    }
                }
                else{
                    if (spaceship.grid_loc.human_y < mdp_parameters.height-1+offset_y && map_layout.color_blocks[spaceship.grid_loc.human_y+1-offset_y][spaceship.grid_loc.human_x-offset_x] != 1){
                        if (passenger.picked_human) {
                            // don't allow the skateboard to go on the path
                            if (map_layout.color_blocks[spaceship.grid_loc.human_y+1-offset_y][spaceship.grid_loc.human_x-offset_x] == 2) {
                                return;
                            }
                            }   
                        spaceship.grid_loc.human_y += 1;
                        if (passenger.picked_human){
                            passenger.grid_loc.human_y += 1;
                        }
                    }
                }
            }

            function pickup(version) {
                if (version == "agent"){
                    if (spaceship.grid_loc.x == passenger.grid_loc.x && spaceship.grid_loc.y == passenger.grid_loc.y && passenger.picked == false){
                        window.moves.push("pickup");
                        passenger.picked = true;
                        window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                }}
                else{
                    console.log("here")
                    if (Math.floor(spaceship.grid_loc.human_x) == Math.floor(passenger.grid_loc.human_x) && spaceship.grid_loc.human_y == passenger.grid_loc.human_y && passenger.picked_human == false){
                        passenger.picked_human = true;
                }}
            }

            function dropoff(version) {
                if (version == "agent"){
                    x = spaceship.grid_loc.x;
                    y = spaceship.grid_loc.y;

                    condition_goal = ((Math.floor(x) == goal.grid_loc.x) && (y == goal.grid_loc.y));

                    if (passenger.picked){
                        window.moves.push("dropoff");
                        passenger.picked = false;
                        window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y])
                        if (condition_goal){
                        passenger.dropped = true;
                            console.log(window.moves);
                        }
                    }
                }
                else{
                    x = spaceship.grid_loc.human_x;
                    y = spaceship.grid_loc.human_y;

                    condition_goal = ((Math.floor(x) == goal.grid_loc.x) && (y == goal.grid_loc.y));

                    if (passenger.picked_human){
                        passenger.picked_human = false;
                        if (condition_goal){
                        passenger.dropped_human = true;
                        }
                    }
                }
            }

            function reset() {

                $jq("#debug")
                    .html("Game is reset. Start again.")
                    .css({
                    "background-color": "#f8d7da", // Light red background
                    }); // Show the message
                // setTimeout(function() {
                //     $jq("#debug").html(""); // Clear the message after 2 seconds
                // }, 2000);

                // Add a one-time keydown event listener to clear the message
                const clearMessage = function() {
                    $jq("#debug").html("")
                    .css("background-color", ""); // Clear the message
                    document.removeEventListener("keydown", clearMessage); // Remove the listener to avoid redundant triggers
                };
                document.addEventListener("keydown", clearMessage); // Listen for any key press

                window.moves = [];
                map_layout.set = false;
                passenger.picked = false;
                passenger.picked_human = false;
                window.agent_history = [];
                window.agent_history_nonoffset = [];
            }

            function no_op(){
                return;
            }

            var idx = 0;
            if (mdp_parameters.tag == -2) {
                var translate_draw = 10;
            }
            else {
                var translate_draw = 0;
            }

            var agent_human_spacer = -0.2;

            function keyPressed(event){
                resetInactivityTimer();
                console.log("key pressed: ", event.key, '. Time: ', Date.now() + performance.now());
                localStorage.setItem("last_activity", event.key);
                localStorage.setItem("last_activity_time", Date.now() + performance.now());
                
                
                if (mdp_parameters.tag == -2) {
                    //training case, agent & human          
                    if (event.keyCode == 32) {
                        //space bar pressed, advance demo
                        var next_action_agent = mdp_parameters.normalized_opt_actions[idx];
                        var next_action_human = mdp_parameters.normalized_human_actions[idx];
                        console.log("agent:" + next_action_agent);
                        console.log("human:" + next_action_human);
                        console.log("idx:" + idx);

                        idx++;
                        switch(next_action_human) {
                            case "left":
                                left("human");
                                break;
                            case "right":
                                right("human");
                                break;
                            case "up":
                                up("human");
                                break;
                            case "down":
                                down("human");
                                break;
                            case "pickup":
                                pickup("human");
                                break;
                            case "dropoff":
                                dropoff("human");
                                break;
                            case "no-op":
                                no_op();
                                break;
                        }
                        switch(next_action_agent) {
                            case "left":
                                left("agent");
                                break;
                            case "right":
                                right("agent");
                                break;
                            case "up":
                                up("agent");
                                break;
                            case "down":
                                down("agent");
                                break;
                            case "pickup":
                                pickup("agent");
                                break;
                            case "dropoff":
                                dropoff("agent");
                                break;
                            case "no-op":
                                no_op();
                                break;
                        }
                        requestAnimationFrame(draw);
                    }
                    else if (event.keyCode == 82) {
                        idx = 0;
                        reset();
                        requestAnimationFrame(draw);
                    }
                } 
                else if (mdp_parameters.tag == -1){
                    //training case, just agent         
                    if (event.keyCode == 32) {
                        //space bar pressed, advance demo
                        var next_action_agent = mdp_parameters.opt_actions[idx];
                        console.log('Idx:', idx);
                        console.log("next agent action: ", next_action_agent);
                        idx++;
                        switch(next_action_agent) {
                            case "left":
                                left("agent");
                                break;
                            case "right":
                                right("agent");
                                break;
                            case "up":
                                up("agent");
                                break;
                            case "down":
                                down("agent");
                                break;
                            case "pickup":
                                pickup("agent");
                                break;
                            case "dropoff":
                                dropoff("agent");
                                break;
                        }
                        window.agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y]);
                        requestAnimationFrame(draw);
                    }
                    else if (event.keyCode == 82) {
                        idx = 0;
                        reset();
                        requestAnimationFrame(draw);
                    }
                } 
                else {
                    //testing case
                    // prevent arrow keys from simultaneously moving the window
                    if([37, 38, 39, 40].indexOf(event.keyCode) > -1) {
                        event.preventDefault();
                    }
                    if (!onGoal("agent")) {
                        switch (event.keyCode) {
                            case 37:
                                // Left Arrow key
                                left("agent");
                                break;
                            case 39:
                                // Right Arrow key
                                right("agent");
                                break;
                            case 38:
                                // Up Arrow key
                                up("agent");
                                break;
                            case 40:
                                // down Arrow key
                                down("agent");
                                break;
                            case 80:
                                //p key
                                pickup("agent");
                                break;
                            case 68:
                                //d key
                                dropoff("agent");
                                break;
                            case 82:
                                //r key
                                idx = 0;
                                reset("agent");
                                break;
                        }
                        if (event.keyCode != 82) window.agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y]);
                        requestAnimationFrame(draw);
                    }
            }
            }

            function filterMovementKeys(event) {
                // This function will run every time a key is pressed...
                if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].indexOf(event.code) > -1) {
                    event.preventDefault();
                }
            }
            
            function mousePressed(event){
                resetInactivityTimer();
                console.log("mouse pressed: ", event.key, '. Time: ', Date.now() + performance.now());
                localStorage.setItem("last_activity", "mouse");
                localStorage.setItem("last_activity_time", Date.now() + performance.now());
            }

            // Debounce the keyPressed function
            var debouncedKeyPressed = _.debounce(keyPressed, 100);
            //var debouncedKeyPressed = keyPressed;

            // Create a new function that calls both functions
            function keydownHandler(event) {
                filterMovementKeys(event);
                debouncedKeyPressed(event);
            }
            
            document.addEventListener('keydown', keydownHandler);

            // Debounce the mousePressed function
            var debouncedMousePressed = _.debounce(mousePressed, 100); // limit consecutive clicks

            // Create a new function that calls both functions
            function mousedownHandler(event) {
                // Call other necessary logic, if applicable
                debouncedMousePressed(event);
            }

            // Add the mousedown listener
            document.addEventListener('mousedown', mousedownHandler);


            start_screen();
            canvas.addEventListener('click', draw);
            context.restore();
            return "finished execution";
        }
    </script>
  </body>
</html>